<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Convolutional Layers | Technicalities</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Convolutional Layers" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A repository of code and other technical stuff." />
<meta property="og:description" content="A repository of code and other technical stuff." />
<link rel="canonical" href="https://jrreed83.github.io/technicalities/jax/convolution/pooling/2022/07/26/jax-01-convolutional-layers.html" />
<meta property="og:url" content="https://jrreed83.github.io/technicalities/jax/convolution/pooling/2022/07/26/jax-01-convolutional-layers.html" />
<meta property="og:site_name" content="Technicalities" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-07-26T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Convolutional Layers" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-07-26T00:00:00-05:00","datePublished":"2022-07-26T00:00:00-05:00","description":"A repository of code and other technical stuff.","headline":"Convolutional Layers","mainEntityOfPage":{"@type":"WebPage","@id":"https://jrreed83.github.io/technicalities/jax/convolution/pooling/2022/07/26/jax-01-convolutional-layers.html"},"url":"https://jrreed83.github.io/technicalities/jax/convolution/pooling/2022/07/26/jax-01-convolutional-layers.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/technicalities/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://jrreed83.github.io/technicalities/feed.xml" title="Technicalities" /><link rel="shortcut icon" type="image/x-icon" href="/technicalities/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.css" integrity="sha512-h7nl+xz8wgDlNM4NqKEM4F1NkIRS17M9+uJwIGwuo8vGqIl4BhuCKdxjWEINm+xyrUjNCnK5dCrhM0sj+wTIXw==" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/katex.min.js" integrity="sha512-/CMIhXiDA3m2c9kzRyd97MTb3MC6OVnx4TElQ7fkkoRghwDf6gi41gaT1PwF270W6+J60uTmwgeRpNpJdRV6sg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.12.0/contrib/auto-render.min.js" integrity="sha512-Do7uJAaHZm5OLrIv/yN4w0iG1dbu01kzdMNnFfu/mAqgUk6Nniv2JYHcwH+cNwjqgLcqcuBBk+JRvprLVI8azg==" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha512-0doc9hKxR3PYwso42RD1p5ySZpzzuDiOwMrdCEh2WdJZCjcmFKc/wEnL+z8fBQrnHoiNWbo+3fiGkOYXBdQp4A==" crossorigin="anonymous"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
        delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
        ]}
        );
    });
    </script>


<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/technicalities/">Technicalities</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/technicalities/about/">About Me</a><a class="page-link" href="/technicalities/search/">Search</a><a class="page-link" href="/technicalities/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Convolutional Layers</h1><p class="post-meta post-meta-title"><time class="dt-published" datetime="2022-07-26T00:00:00-05:00" itemprop="datePublished">
        Jul 26, 2022
      </time>
       â€¢ <span class="read-time" title="Estimated read time">
    
    
      14 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/technicalities/categories/#jax">jax</a>
        &nbsp;
      
        <a class="category-tags-link" href="/technicalities/categories/#convolution">convolution</a>
        &nbsp;
      
        <a class="category-tags-link" href="/technicalities/categories/#pooling">pooling</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-justify-center">
          <div class="px-2">

    <a href="https://github.com/jrreed83/technicalities/tree/master/_notebooks/2022-07-26-jax-01-convolutional-layers.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/technicalities/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/jrreed83/technicalities/master?filepath=_notebooks%2F2022-07-26-jax-01-convolutional-layers.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/technicalities/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/jrreed83/technicalities/blob/master/_notebooks/2022-07-26-jax-01-convolutional-layers.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/technicalities/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
          <div class="px-2">
  <a href="https://deepnote.com/launch?url=https%3A%2F%2Fgithub.com%2Fjrreed83%2Ftechnicalities%2Fblob%2Fmaster%2F_notebooks%2F2022-07-26-jax-01-convolutional-layers.ipynb" target="_blank">
      <img class="notebook-badge-image" src="/technicalities/assets/badges/deepnote.svg" alt="Launch in Deepnote"/>
  </a>
</div>

        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul id="toc" class="section-nav">
<li class="toc-entry toc-h2"><a href="#Introduction">Introduction </a></li>
<li class="toc-entry toc-h2"><a href="#Import-Libraries">Import Libraries </a></li>
<li class="toc-entry toc-h2"><a href="#Convolutional-Layer">Convolutional Layer </a></li>
<li class="toc-entry toc-h2"><a href="#Compare-to-Keras">Compare to Keras </a>
<ul>
<li class="toc-entry toc-h3"><a href="#Convolution-in-JAX">Convolution in JAX </a></li>
</ul>
</li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2022-07-26-jax-01-convolutional-layers.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Introduction">
<a class="anchor" href="#Introduction" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction<a class="anchor-link" href="#Introduction"> </a>
</h2>
<p>In this post, I'll start by implementing a basic convolutional layer using numpy and validate it against Keras.  After this, I'll move onto writing a more efficient one using JAX.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Import-Libraries">
<a class="anchor" href="#Import-Libraries" aria-hidden="true"><span class="octicon octicon-link"></span></a>Import Libraries<a class="anchor-link" href="#Import-Libraries"> </a>
</h2>
<p>For now, I only need numpy and tensorflow.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Here's a small sequential model consisting of a convolutional layer and max-pooling layer.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">'valid'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For this experiment, I don't care what the input to the model is.  So I'll just create a 1-element batch consisting of a random 28-by-28 array and apply <code>model</code> to it.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">inputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">outputs</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2022-07-30 15:14:21.032488: W tensorflow/stream_executor/platform/default/dso_loader.cc:64] Could not load dynamic library 'libcuda.so.1'; dlerror: libcuda.so.1: cannot open shared object file: No such file or directory; LD_LIBRARY_PATH: /usr/local/lib:/usr/local/bin:/usr/local/lib:
2022-07-30 15:14:21.032522: W tensorflow/stream_executor/cuda/cuda_driver.cc:269] failed call to cuInit: UNKNOWN ERROR (303)
2022-07-30 15:14:21.032810: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:156] kernel driver does not appear to be running on this host (pop-os): /proc/driver/nvidia/version does not exist
2022-07-30 15:14:21.041129: I tensorflow/core/platform/cpu_feature_guard.cc:151] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  AVX2 AVX512F FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's check the shape of <code>inputs</code> and <code>outputs</code>.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Feature Mapping:  </span><span class="si">{</span><span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> -&gt; </span><span class="si">{</span><span class="n">outputs</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Feature Mapping:  (1, 28, 28, 3) -&gt; (1, 14, 14, 4)
</pre>
</div>
</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The <code>outputs</code> is a 1-element batch consisting of a 7-by-7 array with 4 channels.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Getting the pooling layer output is easy; it's the same as <code>outputs</code>.  However, it's not immediately obvious how to get the intermediate convolution output. The recommended way to extract the outputs from all the layers in your model is to use the so-called <em>Functional</em> API.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Convolutional-Layer">
<a class="anchor" href="#Convolutional-Layer" aria-hidden="true"><span class="octicon octicon-link"></span></a>Convolutional Layer<a class="anchor-link" href="#Convolutional-Layer"> </a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For now, <code>conv2d</code> is a function of a single, multi-channel image <code>x</code>, <code>kernel</code> is one of the output filters, and <code>strides</code> is a pair of integers defining the number of vertical and horizontal positions</p>
<p>I don't have a good technical reason for making the output array <code>y</code> one dimensional and reshaping at the end; it just looks cleaner than some of the alternatives I played around with.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">filter_image_v1</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">strides</span><span class="p">):</span>
    
    <span class="n">xm</span><span class="p">,</span> <span class="n">xn</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span> 
    <span class="n">km</span><span class="p">,</span> <span class="n">kn</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">kernel</span><span class="o">.</span><span class="n">shape</span> 
    
    <span class="n">sm</span><span class="p">,</span> <span class="n">sn</span> <span class="o">=</span> <span class="n">strides</span>
    <span class="n">ym</span><span class="p">,</span> <span class="n">yn</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">xm</span> <span class="o">-</span> <span class="n">km</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">sm</span><span class="p">),</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">xn</span> <span class="o">-</span> <span class="n">kn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">sn</span><span class="p">)</span>
    
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ym</span><span class="o">*</span><span class="n">yn</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xm</span><span class="o">-</span><span class="n">km</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">sm</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xn</span><span class="o">-</span><span class="n">kn</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">sn</span><span class="p">):</span>
            <span class="n">y</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kernel</span> <span class="o">*</span> <span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">km</span><span class="p">,</span><span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="n">kn</span><span class="p">,:])</span>
            <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
            
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="p">(</span><span class="n">ym</span><span class="p">,</span> <span class="n">yn</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This implementation applies all filters and biases to a single image in the batch, resulting in a rank 3 array.  After doing all the preliminary setup,</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">filter_image_v2</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">biases</span><span class="p">,</span> <span class="n">strides</span><span class="p">):</span>
    
    <span class="n">xm</span><span class="p">,</span> <span class="n">xn</span><span class="p">,</span> <span class="n">_</span>  <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span> 
    <span class="n">km</span><span class="p">,</span> <span class="n">kn</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">no</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">shape</span> 
    
    <span class="c1"># ni =&gt; number of input channels</span>
    <span class="c1"># no =&gt; number of output channels</span>
    
    <span class="n">sm</span><span class="p">,</span> <span class="n">sn</span> <span class="o">=</span> <span class="n">strides</span>
    <span class="n">ym</span><span class="p">,</span> <span class="n">yn</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">xm</span> <span class="o">-</span> <span class="n">km</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">sm</span><span class="p">),</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">xn</span> <span class="o">-</span> <span class="n">kn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="n">sn</span><span class="p">)</span>
    
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ym</span><span class="p">,</span> <span class="n">yn</span><span class="p">,</span> <span class="n">no</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">iy</span><span class="p">,</span> <span class="n">ix</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xm</span><span class="o">-</span><span class="n">km</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">sm</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">jy</span><span class="p">,</span> <span class="n">jx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xn</span><span class="o">-</span><span class="n">kn</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">sn</span><span class="p">)):</span>
            <span class="c1"># Extract the window and apply every output filter to the window</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">image</span><span class="p">[</span><span class="n">ix</span><span class="p">:</span><span class="n">ix</span><span class="o">+</span><span class="n">km</span><span class="p">,</span><span class="n">jx</span><span class="p">:</span><span class="n">jx</span><span class="o">+</span><span class="n">kn</span><span class="p">,:]</span>
            <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">no</span><span class="p">):</span>
                <span class="n">y</span><span class="p">[</span><span class="n">iy</span><span class="p">,</span><span class="n">jy</span><span class="p">,</span><span class="n">channel</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">filters</span><span class="p">[</span><span class="o">...</span><span class="p">,</span><span class="n">channel</span><span class="p">]</span> <span class="o">*</span> <span class="n">window</span><span class="p">)</span> <span class="o">+</span> <span class="n">biases</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span>
            
    <span class="k">return</span> <span class="n">y</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">layer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">'valid'</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">keras_output</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">image</span><span class="p">)[</span><span class="mi">0</span><span class="p">,:,:,:]</span>
<span class="n">filters</span><span class="p">,</span> <span class="n">biases</span> <span class="o">=</span> <span class="n">layer</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
<span class="n">strides</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

<span class="n">filter_image_v2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">image</span><span class="p">),</span> <span class="n">filters</span><span class="p">,</span> <span class="n">biases</span><span class="p">,</span> <span class="n">strides</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>array([[[-1.08534935e-01,  5.39739621e-02,  5.59589955e-01,
          1.08302593e-01],
        [ 6.58584484e-02,  4.46099085e-01,  7.87501674e-01,
         -7.03558574e-01],
        [-8.00203938e-01, -1.33391277e-01, -1.39527965e-01,
         -5.17312697e-01],
        [-5.95222389e-01, -2.30186106e+00, -1.00016599e+00,
         -3.53730820e+00],
        [ 1.05507175e+00,  2.29927715e-01,  7.53264852e-02,
          1.70476202e+00],
        [ 4.23598228e-01, -2.80074382e-01,  1.63063877e+00,
          8.33309978e-01],
        [ 3.20196650e+00,  1.66784160e-01, -3.63189106e-01,
         -1.00131308e-01],
        [ 2.22388031e-01, -1.71247240e+00,  3.77570452e-01,
         -1.13530512e+00],
        [-1.39182051e+00, -6.61468238e-01, -6.18569571e-01,
         -7.34410004e-01],
        [-5.75423405e-01, -1.75251637e-01, -3.71638919e-01,
         -6.08501428e-01],
        [-2.72515885e-01,  2.60302572e+00, -3.36486769e-01,
         -2.30307188e-01],
        [-1.12954774e+00,  4.51343939e-01,  1.01022565e-02,
          3.08121091e-01],
        [-4.57791083e-01,  4.68008899e-01,  9.32450612e-01,
          1.87713655e-01],
        [ 1.20420821e-01,  1.12223469e+00,  6.50391417e-01,
         -1.79007966e+00]],

       [[ 1.06071607e+00,  1.86250082e-01, -1.12135054e+00,
         -1.03586723e+00],
        [-2.22081577e+00, -1.18524031e+00, -7.23786675e-01,
         -1.33940941e+00],
        [ 2.06523111e+00, -1.18856401e+00, -6.05931455e-01,
         -1.19386382e+00],
        [-5.75676135e-01, -1.37663375e+00, -4.41525258e-01,
         -3.57111176e-01],
        [-5.03443195e-01,  4.68532421e-01,  5.63976079e-02,
         -5.71038627e-01],
        [-4.78311245e-01, -5.19261065e-01, -1.15809099e+00,
         -8.56132015e-01],
        [-1.55937088e+00, -1.40712016e-01,  2.83125782e-01,
          6.25061938e-01],
        [-5.58224701e-01, -2.54694744e-01, -5.19107323e-03,
         -5.96165971e-03],
        [-7.60701023e-01,  5.33579439e-01, -1.28246603e+00,
         -7.29071177e-01],
        [-4.80278993e-01,  2.27426484e+00, -7.42849808e-01,
         -7.08220560e-01],
        [-5.52525695e-01, -6.15088805e-01, -1.52104999e+00,
         -9.64048567e-01],
        [ 1.61663634e-01,  5.44248515e-01, -1.40578708e-01,
          3.30340554e-01],
        [-7.96656852e-01, -1.17554058e+00,  6.44463275e-01,
          7.63801373e-01],
        [-9.50344514e-01, -4.60136408e-01,  8.17513675e-01,
          3.60155977e-01]],

       [[-5.26549665e-01,  7.13843995e-02,  1.26334784e+00,
          1.49312716e+00],
        [-6.35335888e-01,  2.05490619e-02,  1.51545411e-01,
          4.20896772e-01],
        [ 4.64617147e-01, -2.43155363e-01,  4.52856506e-01,
         -1.17682982e+00],
        [-1.35134418e+00, -1.28196544e-01,  5.64986787e-01,
          3.20007528e-01],
        [ 2.30542924e-01,  6.45241491e-01, -1.91235957e-01,
         -5.49168933e-01],
        [ 9.32235480e-01, -1.20419137e+00,  3.36090072e-01,
          1.23746049e+00],
        [-8.82636648e-01,  7.33595951e-01, -1.05524850e+00,
         -5.44981594e-01],
        [ 8.24168073e-01, -1.26625631e+00,  1.68800360e+00,
          5.00130838e-01],
        [-5.82975690e-02, -1.95028556e-01, -1.66628355e-01,
          1.00509533e-02],
        [ 2.61621519e-01,  6.98849005e-01,  1.79105685e+00,
          5.64049963e-01],
        [ 1.05035222e+00,  1.28099549e+00, -1.59976018e+00,
         -2.46128259e+00],
        [ 3.70062899e-01, -2.92180430e+00,  5.59764288e-01,
          6.47668216e-01],
        [ 8.36782377e-01,  3.93464340e-01,  2.70005218e-01,
         -1.79588356e-02],
        [ 4.21379077e-02,  5.50240201e-01, -1.89928198e-01,
          8.04878537e-01]],

       [[-3.21820793e-01, -4.37921371e-01,  5.20101223e-01,
         -6.34672796e-01],
        [-2.13600439e-02, -6.68139526e-01,  1.39974718e+00,
          7.80161688e-01],
        [ 2.08550983e+00,  5.49207640e-02,  3.80399934e-01,
          1.44492155e+00],
        [ 1.77928338e+00, -1.75257641e+00,  1.89305448e-01,
          6.64569108e-01],
        [ 3.01838947e-01, -1.88917750e-01, -8.83050193e-01,
         -2.34754167e-01],
        [ 4.35545612e-01,  1.50863400e-01, -3.43782839e-01,
         -3.06592544e-01],
        [ 7.48289146e-01,  1.96735290e+00, -2.18254343e-01,
         -7.91617532e-01],
        [-3.36103947e-01, -1.39217426e+00, -8.23021688e-01,
         -4.68518053e-01],
        [-4.03630212e-01, -6.34256656e-02, -1.03829226e+00,
         -2.23993513e+00],
        [ 8.99566140e-02,  2.69142087e-01, -6.78909346e-01,
          3.61234830e-01],
        [ 1.25898744e+00,  9.47594606e-01,  1.39317017e-02,
          4.00131591e-01],
        [ 1.78919187e-01, -5.21710988e-01, -8.43525977e-01,
          1.64430422e-01],
        [-2.96216306e+00,  1.45985700e-01,  9.07447074e-01,
         -6.05404680e-01],
        [ 1.32135102e+00,  1.56298811e+00, -7.95077762e-01,
          2.34836308e-01]],

       [[ 7.33700895e-01,  7.21452573e-01,  3.33069523e-01,
         -2.71775492e-01],
        [ 6.31696374e-01,  8.29392359e-01, -1.10489874e+00,
         -2.10534029e-01],
        [ 1.12987102e+00, -1.76178253e+00,  1.82782874e+00,
          1.81685010e+00],
        [-1.28311241e+00,  8.57946059e-01, -2.02605574e+00,
         -2.44008425e+00],
        [ 1.51611625e+00,  8.98653125e-01, -3.16339074e-01,
         -2.38007060e-01],
        [ 1.80927131e-01,  8.72481402e-01,  1.23253974e+00,
          6.14915204e-01],
        [ 1.11318681e+00, -1.14512405e+00, -9.61309205e-02,
          8.21035266e-01],
        [-1.37658373e-01,  7.33720754e-01,  5.03685654e-01,
          9.02485954e-01],
        [ 3.60890345e-01, -1.19645130e-01,  7.20030358e-02,
         -9.64768635e-01],
        [-1.14408491e+00,  8.42098990e-01, -1.87789681e+00,
         -5.46689291e-01],
        [-9.48926760e-01, -1.08783078e+00, -4.28408411e-01,
         -7.65318218e-01],
        [ 8.62652435e-01, -1.73449702e+00, -4.35267126e-01,
          6.19419241e-01],
        [-3.93916526e-01,  3.93746733e-01, -1.01900374e+00,
         -1.18678985e+00],
        [-1.20801566e-01, -1.70818292e+00,  9.71925352e-01,
          1.04184539e+00]],

       [[ 1.63510725e+00, -2.89225263e+00,  4.39142061e-01,
          7.69337783e-01],
        [ 6.86903958e-01, -2.08214874e-01, -6.90664111e-01,
          1.86881972e+00],
        [ 3.38664277e-01, -1.04012539e+00,  2.12888567e+00,
          1.67969294e-01],
        [-1.08562950e+00, -6.62843139e-01,  6.63646527e-01,
          2.53441294e-01],
        [-1.21802272e-01,  9.05985500e-01, -1.07776776e+00,
         -1.56844500e+00],
        [ 1.33997675e+00, -1.22687370e+00,  7.94370847e-01,
         -1.58237401e+00],
        [ 1.55762112e+00,  6.67602005e-01, -1.54409682e-01,
          1.47135236e-01],
        [-5.75358704e-02, -1.32293522e+00,  4.71672547e-01,
          6.18910106e-01],
        [ 4.19712084e-01,  1.63544755e+00,  1.03346223e+00,
         -1.74915024e-01],
        [ 1.81799416e-01, -1.50958673e-01, -4.15027552e-01,
          3.95611939e-01],
        [ 4.94134234e-01, -7.69990183e-02,  2.72208140e-01,
         -1.71383398e+00],
        [ 1.54660083e+00, -1.35688351e-04,  6.13811991e-01,
         -2.01147901e-01],
        [ 1.88793160e+00,  6.67188191e-01,  7.64198393e-01,
          2.28986729e+00],
        [-9.55646255e-02,  1.56582843e+00, -6.17479343e-01,
         -1.38367389e+00]],

       [[-2.38365732e-01,  6.14964373e-01, -1.35605089e+00,
         -1.43356045e+00],
        [-1.09800068e+00,  1.75186759e-01,  1.30616650e-01,
         -2.20297222e-02],
        [ 1.15644997e+00,  2.33505751e-01, -5.72600188e-01,
         -1.05946621e+00],
        [-1.73660006e+00, -3.94900910e-01,  9.26739148e-02,
         -5.85641705e-01],
        [-1.57587964e+00, -1.36366153e-01,  1.11837456e+00,
          2.87977475e-01],
        [ 1.60247114e+00, -1.95179522e+00,  1.47675040e+00,
         -5.03307862e-01],
        [ 1.25961715e+00, -3.70813981e-01, -8.88961872e-01,
         -4.20217934e-01],
        [-5.04871352e-01,  1.76949168e+00,  3.89147712e-01,
          1.14987067e+00],
        [-6.31826807e-01,  1.11732531e+00,  4.50251651e-01,
          1.53824718e+00],
        [ 6.00655335e-01, -2.00587690e+00,  1.57035097e+00,
          6.50898085e-01],
        [-8.49578780e-01, -1.16737667e+00, -9.08334442e-02,
         -1.29790300e+00],
        [ 1.18389726e+00, -4.48007169e-01, -1.87256307e-02,
         -1.36590920e+00],
        [ 1.10067402e-01,  2.37302321e-01,  8.32556497e-01,
         -6.53012413e-01],
        [-7.82673967e-01, -4.47991091e-01,  2.74813791e-01,
          4.66474819e-01]],

       [[-7.89370643e-01,  1.27542898e-02, -4.13965537e-01,
         -4.66823291e-01],
        [ 6.36052605e-01, -1.69723748e+00,  1.31340648e+00,
         -9.38050474e-01],
        [ 9.31857486e-02,  6.95028528e-01,  4.73023852e-02,
          6.27228059e-01],
        [ 1.28796819e+00,  1.07655941e+00,  9.19095977e-01,
          7.38679673e-01],
        [-5.94836390e-01,  1.01650706e+00, -9.13408115e-01,
         -7.02155646e-01],
        [ 6.93090493e-02, -8.25458402e-01,  1.52131397e+00,
          1.20986884e+00],
        [-1.42170658e+00,  1.79300002e+00,  3.32482900e-01,
          7.03627177e-01],
        [-1.53591655e+00,  6.98559143e-01,  1.66761194e-01,
         -7.07108156e-02],
        [-1.60460557e+00, -3.55176212e-02, -3.98490619e-01,
         -4.66271743e-01],
        [ 5.66831899e-01,  4.60471580e-01,  1.45608635e+00,
          2.37173604e-01],
        [-9.28538747e-01, -1.98191493e+00, -7.52506281e-02,
         -1.19602029e+00],
        [-6.29803742e-01,  8.56786621e-01, -1.15623531e+00,
         -9.01459154e-01],
        [-7.74876866e-01, -3.11113216e-01,  4.79935702e-01,
          7.87763751e-01],
        [-1.25330583e+00, -1.04766697e+00,  1.86188889e-01,
          2.03723729e-01]],

       [[-1.79307227e+00,  4.34055419e-01,  2.10856289e-01,
         -1.34449009e+00],
        [-9.29482212e-01, -1.17013973e-01, -1.48197639e+00,
          8.39178905e-01],
        [-7.57466429e-01,  1.30548566e+00,  8.54380504e-01,
          8.05913170e-01],
        [ 9.41950986e-01,  4.82261478e-01,  1.23100425e+00,
         -4.73274815e-02],
        [ 4.42949121e-01,  1.37907665e+00, -4.06138967e-01,
         -3.68676546e-01],
        [-2.43414386e-01, -1.45718315e-01, -2.21351646e-01,
         -9.14959311e-01],
        [-2.37183603e-01,  2.00496116e-01,  6.62646057e-01,
          1.29164982e-01],
        [ 1.52734010e-01, -1.85361386e+00, -5.56199972e-01,
          6.72583182e-01],
        [ 1.49200566e+00,  6.05512100e-01,  1.54082461e+00,
          5.21992501e-01],
        [ 2.29517628e+00, -3.55160833e-02, -1.81623891e-01,
          9.95306053e-02],
        [-1.69960710e+00, -1.14405880e+00, -7.07590170e-01,
         -6.68440056e-01],
        [-6.13351828e-01,  1.61809986e+00,  5.45527024e-01,
          1.19279420e+00],
        [-1.81197633e+00,  9.30149816e-01, -5.86725867e-01,
         -2.66145013e-01],
        [ 1.86397450e+00, -1.84515094e-01, -1.16252671e+00,
          8.00484697e-01]],

       [[ 3.32099358e-01, -1.10675661e+00, -3.12155765e-01,
         -8.69601081e-01],
        [ 4.28311015e-01,  3.76852620e-01,  5.19666404e-01,
          1.51554517e+00],
        [ 1.11050731e+00,  4.28255287e-01,  9.59697806e-01,
          2.08977203e+00],
        [-1.55767915e+00, -9.13373274e-01,  3.29809669e-01,
         -2.67510605e-01],
        [ 1.80124606e-01, -1.18187702e+00, -3.50638977e-02,
          1.21296139e+00],
        [ 7.37140795e-01, -5.83136035e-01, -3.01917392e-01,
         -9.08436202e-01],
        [ 4.94308837e-01, -5.84883233e-01,  1.28648072e+00,
          2.40040890e+00],
        [-2.15927816e+00, -9.24290674e-01,  2.30851289e-01,
         -1.30538218e+00],
        [-1.53762980e-01, -5.19219232e-01,  8.31048757e-01,
          6.32107417e-01],
        [ 1.77948729e+00,  1.10923144e+00, -5.84444774e-02,
          1.60808436e+00],
        [-9.80144885e-01, -5.12977943e-02,  1.12166770e+00,
         -1.24863969e+00],
        [ 9.72052017e-01, -9.74728004e-01, -2.06964516e+00,
         -5.57865802e-02],
        [ 4.43634067e-01, -2.56254688e-01,  1.25252883e+00,
          1.91266084e+00],
        [-7.00551847e-01, -2.22244200e-01,  8.73583871e-01,
          7.58802974e-01]],

       [[ 2.59940143e-01,  2.17036420e-01, -8.73864388e-01,
          7.19878523e-01],
        [-1.06894221e+00,  1.24761180e+00,  1.56542190e-01,
         -2.79515393e+00],
        [ 7.79925457e-02,  1.15804185e+00, -1.32901206e-02,
          1.40960771e+00],
        [-6.79657924e-01,  8.14683481e-01,  5.38237458e-03,
         -3.10152552e-01],
        [-1.28330276e+00,  2.13716817e+00, -6.30271325e-01,
         -8.15246326e-01],
        [ 4.34809661e-01, -1.01608945e+00, -5.04562342e-01,
         -1.00705886e+00],
        [ 6.32846896e-01, -4.93535205e-01, -1.37089751e+00,
         -8.18413028e-01],
        [-3.91362326e-01,  2.61658475e-01,  4.36216182e-01,
          1.07371366e+00],
        [-2.33848545e-01,  4.57022117e-02, -1.74228213e-01,
          7.56453960e-01],
        [ 1.62870584e+00,  3.05399526e-01, -7.25499094e-01,
         -1.60986241e+00],
        [-5.61085000e-01, -4.32486339e-01,  4.31925159e-01,
         -5.61031025e-02],
        [-1.06962664e+00, -2.68130113e-01, -9.90508148e-01,
         -2.36094364e+00],
        [-2.06467689e+00,  5.52735047e-02, -1.19800911e+00,
         -1.30171002e+00],
        [-6.57363373e-01, -1.19093132e+00, -3.25838716e-01,
         -1.30660803e+00]],

       [[-1.41321300e+00,  1.11227357e+00, -9.40028568e-01,
         -1.58812309e+00],
        [ 1.01825203e+00,  6.33007095e-01, -1.58724476e-01,
         -1.38498358e-03],
        [-1.39274229e+00, -1.17146300e+00,  2.17234222e+00,
          9.32039791e-01],
        [-1.24634595e-01, -7.01815995e-01, -7.25708768e-02,
          1.79367675e-01],
        [-2.72540675e-01, -4.35504694e-01,  1.59408462e-01,
          2.45156719e-01],
        [-1.56879504e+00, -5.49107636e-01,  4.49320419e-01,
         -6.76808766e-03],
        [-1.20282875e-02, -2.18756651e-01, -4.69418891e-01,
         -1.10417987e+00],
        [-3.92034500e-01,  1.54110564e+00, -7.58286365e-01,
         -8.52428347e-02],
        [ 6.33645640e-01, -2.42153333e-01, -9.68658597e-01,
         -1.39430594e+00],
        [ 3.67107950e-01, -4.63004921e-01,  4.36341628e-01,
          1.00393020e+00],
        [ 8.70179682e-01,  1.89783472e-01,  1.19264127e+00,
          5.80198290e-01],
        [ 3.50170454e+00,  7.04873971e-01,  6.32298497e-01,
          6.81915222e-01],
        [-6.88166678e-01,  2.56432209e-01, -2.50965623e-01,
         -1.66251296e+00],
        [-1.60978137e+00, -1.26224865e+00, -8.66071991e-01,
         -8.46488590e-01]],

       [[-9.50444103e-01, -5.37213992e-01, -1.77501840e+00,
         -2.87561393e-01],
        [-2.19760631e-01, -2.14341401e+00, -2.23229760e+00,
         -1.14324345e+00],
        [ 2.65320893e+00, -6.66932628e-01,  7.01575446e-01,
          1.88909298e+00],
        [ 1.60594866e+00,  2.35495880e-01,  8.03578480e-01,
          2.95723805e-01],
        [-1.06264104e+00, -1.32872152e+00,  9.96315168e-01,
         -7.08588429e-01],
        [-1.12833637e+00,  2.08714395e-01, -2.45760893e-01,
         -8.60233930e-01],
        [ 3.01181505e-01, -2.14838081e+00,  9.59586738e-01,
         -6.01829075e-01],
        [-1.22550978e+00, -6.92308497e-01,  9.39194469e-01,
         -9.87570299e-01],
        [ 5.54289112e-01, -7.86062849e-01,  7.13532985e-01,
          5.69297863e-01],
        [ 1.89930160e-01,  1.66581842e-01,  1.42751965e+00,
          1.55477254e+00],
        [-1.13455661e+00, -1.77855849e+00,  1.92666908e-02,
         -7.73636911e-01],
        [-7.58100200e-02,  3.90152307e-01, -2.50964669e+00,
         -8.11170275e-01],
        [ 2.38763854e+00, -3.42811826e-01, -1.10787322e+00,
          1.76546399e+00],
        [-1.86907499e+00, -1.37142240e+00,  1.81962516e-01,
          7.45815606e-01]],

       [[-1.05248122e+00,  6.03966509e-01, -2.39483957e-01,
         -1.17313943e+00],
        [ 1.86544563e-01,  1.59363402e+00, -5.57092959e-01,
         -1.96814233e+00],
        [-5.06630128e-02, -4.11412844e-01, -2.96671261e-01,
         -4.83482552e-01],
        [-1.22728001e-01, -1.17298235e+00, -1.05138130e+00,
         -1.19741774e+00],
        [ 3.71420313e-01, -7.28542283e-01, -5.80820087e-01,
         -5.74894099e-01],
        [-1.37938384e+00, -1.41419922e+00,  6.06455224e-01,
         -2.54376839e-01],
        [ 2.86744064e-02,  1.12663458e+00, -6.43594754e-01,
         -1.48150458e+00],
        [ 2.80126516e-01,  3.82072947e-01,  5.82066491e-01,
          1.75931195e+00],
        [ 4.52503539e-01, -2.12649568e+00, -4.11068658e-01,
          8.08981610e-01],
        [-4.34542893e-01, -2.12306785e+00,  9.15421426e-01,
          6.69635277e-01],
        [-1.26591373e+00, -1.41119583e+00, -6.10195594e-01,
         -1.10120913e+00],
        [ 1.22447950e+00,  7.01043096e-01, -4.33282318e-02,
         -1.90888956e-01],
        [-8.05281277e-01, -3.65723497e-01,  1.56877007e+00,
          2.05629786e+00],
        [ 6.75398792e-01,  1.03568773e+00, -9.04068132e-01,
          1.83187055e-01]]])</pre>
</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">keras_output</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&lt;tf.Tensor: shape=(14, 14, 4), dtype=float32, numpy=
array([[[-1.08534932e-01,  5.39739281e-02,  5.59589982e-01,
          1.08302608e-01],
        [ 6.58584684e-02,  4.46099073e-01,  7.87501693e-01,
         -7.03558564e-01],
        [-8.00204039e-01, -1.33391246e-01, -1.39527947e-01,
         -5.17312586e-01],
        [-5.95222414e-01, -2.30186105e+00, -1.00016594e+00,
         -3.53730822e+00],
        [ 1.05507171e+00,  2.29927674e-01,  7.53264874e-02,
          1.70476198e+00],
        [ 4.23598200e-01, -2.80074388e-01,  1.63063884e+00,
          8.33309948e-01],
        [ 3.20196629e+00,  1.66784167e-01, -3.63189101e-01,
         -1.00131355e-01],
        [ 2.22388119e-01, -1.71247244e+00,  3.77570391e-01,
         -1.13530517e+00],
        [-1.39182055e+00, -6.61468208e-01, -6.18569613e-01,
         -7.34409988e-01],
        [-5.75423360e-01, -1.75251648e-01, -3.71638924e-01,
         -6.08501554e-01],
        [-2.72515923e-01,  2.60302567e+00, -3.36486816e-01,
         -2.30307281e-01],
        [-1.12954760e+00,  4.51343954e-01,  1.01022692e-02,
          3.08121145e-01],
        [-4.57791179e-01,  4.68008727e-01,  9.32450652e-01,
          1.87713638e-01],
        [ 1.20420828e-01,  1.12223458e+00,  6.50391400e-01,
         -1.79007971e+00]],

       [[ 1.06071603e+00,  1.86250046e-01, -1.12135053e+00,
         -1.03586721e+00],
        [-2.22081566e+00, -1.18524039e+00, -7.23786652e-01,
         -1.33940923e+00],
        [ 2.06523108e+00, -1.18856406e+00, -6.05931461e-01,
         -1.19386375e+00],
        [-5.75676084e-01, -1.37663376e+00, -4.41525280e-01,
         -3.57111156e-01],
        [-5.03443062e-01,  4.68532383e-01,  5.63976914e-02,
         -5.71038723e-01],
        [-4.78311151e-01, -5.19261062e-01, -1.15809095e+00,
         -8.56131971e-01],
        [-1.55937099e+00, -1.40712038e-01,  2.83125848e-01,
          6.25061929e-01],
        [-5.58224738e-01, -2.54694760e-01, -5.19106491e-03,
         -5.96173620e-03],
        [-7.60700881e-01,  5.33579469e-01, -1.28246605e+00,
         -7.29071140e-01],
        [-4.80279028e-01,  2.27426457e+00, -7.42849827e-01,
         -7.08220541e-01],
        [-5.52525699e-01, -6.15088820e-01, -1.52104998e+00,
         -9.64048624e-01],
        [ 1.61663607e-01,  5.44248462e-01, -1.40578777e-01,
          3.30340534e-01],
        [-7.96656907e-01, -1.17554069e+00,  6.44463241e-01,
          7.63801396e-01],
        [-9.50344563e-01, -4.60136354e-01,  8.17513645e-01,
          3.60155880e-01]],

       [[-5.26549637e-01,  7.13843778e-02,  1.26334786e+00,
          1.49312711e+00],
        [-6.35335982e-01,  2.05490887e-02,  1.51545420e-01,
          4.20896798e-01],
        [ 4.64617074e-01, -2.43155345e-01,  4.52856481e-01,
         -1.17682981e+00],
        [-1.35134423e+00, -1.28196523e-01,  5.64986706e-01,
          3.20007563e-01],
        [ 2.30542943e-01,  6.45241499e-01, -1.91235960e-01,
         -5.49168885e-01],
        [ 9.32235479e-01, -1.20419133e+00,  3.36090088e-01,
          1.23746049e+00],
        [-8.82636726e-01,  7.33595967e-01, -1.05524850e+00,
         -5.44981599e-01],
        [ 8.24168026e-01, -1.26625633e+00,  1.68800354e+00,
          5.00130832e-01],
        [-5.82975633e-02, -1.95028558e-01, -1.66628361e-01,
          1.00509794e-02],
        [ 2.61621535e-01,  6.98848963e-01,  1.79105675e+00,
          5.64050019e-01],
        [ 1.05035222e+00,  1.28099549e+00, -1.59976029e+00,
         -2.46128249e+00],
        [ 3.70063007e-01, -2.92180443e+00,  5.59764326e-01,
          6.47668242e-01],
        [ 8.36782455e-01,  3.93464327e-01,  2.70005167e-01,
         -1.79588441e-02],
        [ 4.21378911e-02,  5.50240338e-01, -1.89928219e-01,
          8.04878592e-01]],

       [[-3.21820796e-01, -4.37921375e-01,  5.20101249e-01,
         -6.34672701e-01],
        [-2.13602167e-02, -6.68139577e-01,  1.39974725e+00,
          7.80161679e-01],
        [ 2.08550954e+00,  5.49207889e-02,  3.80399883e-01,
          1.44492173e+00],
        [ 1.77928340e+00, -1.75257647e+00,  1.89305440e-01,
          6.64569020e-01],
        [ 3.01838905e-01, -1.88917741e-01, -8.83050144e-01,
         -2.34754160e-01],
        [ 4.35545743e-01,  1.50863409e-01, -3.43782872e-01,
         -3.06592584e-01],
        [ 7.48289108e-01,  1.96735287e+00, -2.18254358e-01,
         -7.91617692e-01],
        [-3.36103976e-01, -1.39217424e+00, -8.23021710e-01,
         -4.68518078e-01],
        [-4.03630257e-01, -6.34256527e-02, -1.03829229e+00,
         -2.23993492e+00],
        [ 8.99565890e-02,  2.69142032e-01, -6.78909361e-01,
          3.61234814e-01],
        [ 1.25898743e+00,  9.47594643e-01,  1.39316609e-02,
          4.00131553e-01],
        [ 1.78919226e-01, -5.21710992e-01, -8.43526006e-01,
          1.64430380e-01],
        [-2.96216297e+00,  1.45985723e-01,  9.07447219e-01,
         -6.05404556e-01],
        [ 1.32135117e+00,  1.56298828e+00, -7.95077801e-01,
          2.34836355e-01]],

       [[ 7.33700812e-01,  7.21452534e-01,  3.33069474e-01,
         -2.71775484e-01],
        [ 6.31696463e-01,  8.29392433e-01, -1.10489869e+00,
         -2.10534021e-01],
        [ 1.12987101e+00, -1.76178265e+00,  1.82782876e+00,
          1.81685019e+00],
        [-1.28311241e+00,  8.57945919e-01, -2.02605581e+00,
         -2.44008398e+00],
        [ 1.51611614e+00,  8.98653150e-01, -3.16339046e-01,
         -2.38007054e-01],
        [ 1.80927143e-01,  8.72481406e-01,  1.23253977e+00,
          6.14915192e-01],
        [ 1.11318684e+00, -1.14512384e+00, -9.61309150e-02,
          8.21035206e-01],
        [-1.37658343e-01,  7.33720720e-01,  5.03685653e-01,
          9.02485967e-01],
        [ 3.60890329e-01, -1.19645141e-01,  7.20030069e-02,
         -9.64768827e-01],
        [-1.14408493e+00,  8.42099071e-01, -1.87789690e+00,
         -5.46689212e-01],
        [-9.48926687e-01, -1.08783078e+00, -4.28408384e-01,
         -7.65318215e-01],
        [ 8.62652481e-01, -1.73449707e+00, -4.35267180e-01,
          6.19419217e-01],
        [-3.93916517e-01,  3.93746823e-01, -1.01900363e+00,
         -1.18678987e+00],
        [-1.20801575e-01, -1.70818281e+00,  9.71925378e-01,
          1.04184532e+00]],

       [[ 1.63510728e+00, -2.89225292e+00,  4.39141989e-01,
          7.69337773e-01],
        [ 6.86904013e-01, -2.08214924e-01, -6.90664053e-01,
          1.86881995e+00],
        [ 3.38664263e-01, -1.04012525e+00,  2.12888575e+00,
          1.67969376e-01],
        [-1.08562946e+00, -6.62843168e-01,  6.63646460e-01,
          2.53441304e-01],
        [-1.21802270e-01,  9.05985534e-01, -1.07776773e+00,
         -1.56844497e+00],
        [ 1.33997691e+00, -1.22687376e+00,  7.94370770e-01,
         -1.58237398e+00],
        [ 1.55762112e+00,  6.67602003e-01, -1.54409677e-01,
          1.47135213e-01],
        [-5.75358644e-02, -1.32293522e+00,  4.71672505e-01,
          6.18910134e-01],
        [ 4.19711977e-01,  1.63544750e+00,  1.03346217e+00,
         -1.74915075e-01],
        [ 1.81799382e-01, -1.50958717e-01, -4.15027529e-01,
          3.95611852e-01],
        [ 4.94134218e-01, -7.69989789e-02,  2.72208065e-01,
         -1.71383393e+00],
        [ 1.54660082e+00, -1.35685608e-04,  6.13812029e-01,
         -2.01147959e-01],
        [ 1.88793170e+00,  6.67188168e-01,  7.64198422e-01,
          2.28986716e+00],
        [-9.55646485e-02,  1.56582856e+00, -6.17479324e-01,
         -1.38367391e+00]],

       [[-2.38365754e-01,  6.14964306e-01, -1.35605085e+00,
         -1.43356037e+00],
        [-1.09800065e+00,  1.75186679e-01,  1.30616650e-01,
         -2.20298097e-02],
        [ 1.15645003e+00,  2.33505771e-01, -5.72600305e-01,
         -1.05946624e+00],
        [-1.73660016e+00, -3.94900888e-01,  9.26738828e-02,
         -5.85641682e-01],
        [-1.57587969e+00, -1.36366144e-01,  1.11837459e+00,
          2.87977487e-01],
        [ 1.60247111e+00, -1.95179534e+00,  1.47675037e+00,
         -5.03307819e-01],
        [ 1.25961721e+00, -3.70813996e-01, -8.88961852e-01,
         -4.20217991e-01],
        [-5.04871368e-01,  1.76949131e+00,  3.89147669e-01,
          1.14987075e+00],
        [-6.31826699e-01,  1.11732531e+00,  4.50251698e-01,
          1.53824723e+00],
        [ 6.00655258e-01, -2.00587678e+00,  1.57035089e+00,
          6.50897980e-01],
        [-8.49578738e-01, -1.16737676e+00, -9.08334404e-02,
         -1.29790306e+00],
        [ 1.18389726e+00, -4.48007196e-01, -1.87256746e-02,
         -1.36590922e+00],
        [ 1.10067330e-01,  2.37302274e-01,  8.32556486e-01,
         -6.53012335e-01],
        [-7.82673955e-01, -4.47991133e-01,  2.74813801e-01,
          4.66474861e-01]],

       [[-7.89370656e-01,  1.27542811e-02, -4.13965583e-01,
         -4.66823250e-01],
        [ 6.36052549e-01, -1.69723749e+00,  1.31340671e+00,
         -9.38050449e-01],
        [ 9.31857601e-02,  6.95028543e-01,  4.73023541e-02,
          6.27228022e-01],
        [ 1.28796816e+00,  1.07655942e+00,  9.19095933e-01,
          7.38679647e-01],
        [-5.94836473e-01,  1.01650703e+00, -9.13408101e-01,
         -7.02155590e-01],
        [ 6.93091154e-02, -8.25458348e-01,  1.52131402e+00,
          1.20986879e+00],
        [-1.42170656e+00,  1.79299998e+00,  3.32482874e-01,
          7.03627110e-01],
        [-1.53591669e+00,  6.98559105e-01,  1.66761175e-01,
         -7.07108006e-02],
        [-1.60460556e+00, -3.55177373e-02, -3.98490548e-01,
         -4.66271698e-01],
        [ 5.66831946e-01,  4.60471570e-01,  1.45608640e+00,
          2.37173617e-01],
        [-9.28538680e-01, -1.98191488e+00, -7.52505884e-02,
         -1.19602025e+00],
        [-6.29803777e-01,  8.56786668e-01, -1.15623534e+00,
         -9.01459217e-01],
        [-7.74876893e-01, -3.11113328e-01,  4.79935646e-01,
          7.87763894e-01],
        [-1.25330579e+00, -1.04766703e+00,  1.86188906e-01,
          2.03723669e-01]],

       [[-1.79307222e+00,  4.34055418e-01,  2.10856318e-01,
         -1.34448993e+00],
        [-9.29482162e-01, -1.17013961e-01, -1.48197639e+00,
          8.39178920e-01],
        [-7.57466495e-01,  1.30548573e+00,  8.54380548e-01,
          8.05913150e-01],
        [ 9.41951036e-01,  4.82261449e-01,  1.23100424e+00,
         -4.73274179e-02],
        [ 4.42949057e-01,  1.37907672e+00, -4.06138927e-01,
         -3.68676603e-01],
        [-2.43414417e-01, -1.45718381e-01, -2.21351758e-01,
         -9.14959311e-01],
        [-2.37183616e-01,  2.00496182e-01,  6.62645996e-01,
          1.29164994e-01],
        [ 1.52734026e-01, -1.85361385e+00, -5.56200027e-01,
          6.72583163e-01],
        [ 1.49200559e+00,  6.05512083e-01,  1.54082453e+00,
          5.21992445e-01],
        [ 2.29517627e+00, -3.55160050e-02, -1.81623876e-01,
          9.95306373e-02],
        [-1.69960713e+00, -1.14405882e+00, -7.07590163e-01,
         -6.68440044e-01],
        [-6.13351882e-01,  1.61809993e+00,  5.45526981e-01,
          1.19279420e+00],
        [-1.81197619e+00,  9.30149794e-01, -5.86725891e-01,
         -2.66144961e-01],
        [ 1.86397457e+00, -1.84515104e-01, -1.16252673e+00,
          8.00484657e-01]],

       [[ 3.32099319e-01, -1.10675657e+00, -3.12155753e-01,
         -8.69601011e-01],
        [ 4.28310990e-01,  3.76852661e-01,  5.19666374e-01,
          1.51554513e+00],
        [ 1.11050725e+00,  4.28255230e-01,  9.59697783e-01,
          2.08977222e+00],
        [-1.55767918e+00, -9.13373351e-01,  3.29809666e-01,
         -2.67510682e-01],
        [ 1.80124566e-01, -1.18187702e+00, -3.50638703e-02,
          1.21296132e+00],
        [ 7.37140656e-01, -5.83136022e-01, -3.01917404e-01,
         -9.08436239e-01],
        [ 4.94308859e-01, -5.84883213e-01,  1.28648078e+00,
          2.40040898e+00],
        [-2.15927815e+00, -9.24290717e-01,  2.30851427e-01,
         -1.30538213e+00],
        [-1.53762996e-01, -5.19219220e-01,  8.31048727e-01,
          6.32107258e-01],
        [ 1.77948737e+00,  1.10923147e+00, -5.84444888e-02,
          1.60808432e+00],
        [-9.80144799e-01, -5.12977801e-02,  1.12166762e+00,
         -1.24863970e+00],
        [ 9.72052038e-01, -9.74727988e-01, -2.06964493e+00,
         -5.57865277e-02],
        [ 4.43634152e-01, -2.56254673e-01,  1.25252891e+00,
          1.91266084e+00],
        [-7.00551867e-01, -2.22244173e-01,  8.73583913e-01,
          7.58802950e-01]],

       [[ 2.59940118e-01,  2.17036411e-01, -8.73864353e-01,
          7.19878495e-01],
        [-1.06894207e+00,  1.24761176e+00,  1.56542331e-01,
         -2.79515386e+00],
        [ 7.79924765e-02,  1.15804183e+00, -1.32900281e-02,
          1.40960765e+00],
        [-6.79657936e-01,  8.14683616e-01,  5.38235111e-03,
         -3.10152590e-01],
        [-1.28330278e+00,  2.13716793e+00, -6.30271375e-01,
         -8.15246463e-01],
        [ 4.34809774e-01, -1.01608956e+00, -5.04562199e-01,
         -1.00705886e+00],
        [ 6.32846951e-01, -4.93535191e-01, -1.37089753e+00,
         -8.18413019e-01],
        [-3.91362309e-01,  2.61658460e-01,  4.36216146e-01,
          1.07371366e+00],
        [-2.33848497e-01,  4.57022674e-02, -1.74228251e-01,
          7.56453931e-01],
        [ 1.62870586e+00,  3.05399477e-01, -7.25499153e-01,
         -1.60986233e+00],
        [-5.61084926e-01, -4.32486415e-01,  4.31925148e-01,
         -5.61031774e-02],
        [-1.06962669e+00, -2.68130153e-01, -9.90508139e-01,
         -2.36094356e+00],
        [-2.06467676e+00,  5.52734993e-02, -1.19800889e+00,
         -1.30171001e+00],
        [-6.57363415e-01, -1.19093132e+00, -3.25838715e-01,
         -1.30660808e+00]],

       [[-1.41321301e+00,  1.11227357e+00, -9.40028548e-01,
         -1.58812308e+00],
        [ 1.01825202e+00,  6.33007109e-01, -1.58724397e-01,
         -1.38489553e-03],
        [-1.39274216e+00, -1.17146301e+00,  2.17234230e+00,
          9.32039917e-01],
        [-1.24634646e-01, -7.01816022e-01, -7.25708604e-02,
          1.79367661e-01],
        [-2.72540927e-01, -4.35504794e-01,  1.59408495e-01,
          2.45156690e-01],
        [-1.56879520e+00, -5.49107671e-01,  4.49320436e-01,
         -6.76810881e-03],
        [-1.20282853e-02, -2.18756557e-01, -4.69418943e-01,
         -1.10417986e+00],
        [-3.92034501e-01,  1.54110563e+00, -7.58286357e-01,
         -8.52428675e-02],
        [ 6.33645833e-01, -2.42153361e-01, -9.68658686e-01,
         -1.39430594e+00],
        [ 3.67107987e-01, -4.63004947e-01,  4.36341614e-01,
          1.00393021e+00],
        [ 8.70179713e-01,  1.89783514e-01,  1.19264126e+00,
          5.80198288e-01],
        [ 3.50170469e+00,  7.04873979e-01,  6.32298470e-01,
          6.81915283e-01],
        [-6.88166678e-01,  2.56432265e-01, -2.50965685e-01,
         -1.66251290e+00],
        [-1.60978138e+00, -1.26224864e+00, -8.66071880e-01,
         -8.46488595e-01]],

       [[-9.50444162e-01, -5.37214100e-01, -1.77501833e+00,
         -2.87561446e-01],
        [-2.19760612e-01, -2.14341402e+00, -2.23229766e+00,
         -1.14324355e+00],
        [ 2.65320873e+00, -6.66932583e-01,  7.01575458e-01,
          1.88909292e+00],
        [ 1.60594857e+00,  2.35495955e-01,  8.03578436e-01,
          2.95723826e-01],
        [-1.06264102e+00, -1.32872152e+00,  9.96315181e-01,
         -7.08588362e-01],
        [-1.12833643e+00,  2.08714411e-01, -2.45760888e-01,
         -8.60233963e-01],
        [ 3.01181555e-01, -2.14838076e+00,  9.59586740e-01,
         -6.01829112e-01],
        [-1.22550976e+00, -6.92308486e-01,  9.39194500e-01,
         -9.87570286e-01],
        [ 5.54289162e-01, -7.86062777e-01,  7.13532984e-01,
          5.69297910e-01],
        [ 1.89930201e-01,  1.66581839e-01,  1.42751968e+00,
          1.55477250e+00],
        [-1.13455677e+00, -1.77855849e+00,  1.92667115e-02,
         -7.73636937e-01],
        [-7.58100897e-02,  3.90152395e-01, -2.50964665e+00,
         -8.11170340e-01],
        [ 2.38763857e+00, -3.42811793e-01, -1.10787320e+00,
          1.76546395e+00],
        [-1.86907518e+00, -1.37142229e+00,  1.81962535e-01,
          7.45815635e-01]],

       [[-1.05248129e+00,  6.03966594e-01, -2.39483923e-01,
         -1.17313945e+00],
        [ 1.86544538e-01,  1.59363401e+00, -5.57093024e-01,
         -1.96814215e+00],
        [-5.06630503e-02, -4.11412865e-01, -2.96671242e-01,
         -4.83482569e-01],
        [-1.22727945e-01, -1.17298234e+00, -1.05138123e+00,
         -1.19741774e+00],
        [ 3.71420354e-01, -7.28542209e-01, -5.80820084e-01,
         -5.74894190e-01],
        [-1.37938404e+00, -1.41419911e+00,  6.06455326e-01,
         -2.54376888e-01],
        [ 2.86743753e-02,  1.12663460e+00, -6.43594742e-01,
         -1.48150456e+00],
        [ 2.80126512e-01,  3.82072926e-01,  5.82066476e-01,
          1.75931191e+00],
        [ 4.52503473e-01, -2.12649560e+00, -4.11068678e-01,
          8.08981478e-01],
        [-4.34542954e-01, -2.12306786e+00,  9.15421367e-01,
          6.69635177e-01],
        [-1.26591372e+00, -1.41119587e+00, -6.10195577e-01,
         -1.10120904e+00],
        [ 1.22447944e+00,  7.01043069e-01, -4.33282517e-02,
         -1.90888941e-01],
        [-8.05281281e-01, -3.65723550e-01,  1.56877005e+00,
          2.05629778e+00],
        [ 6.75398827e-01,  1.03568780e+00, -9.04068172e-01,
          1.83187112e-01]]], dtype=float32)&gt;</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now I can make a little class that contains the filters, biases, and other necessary parameters for a convolutional layer.  The <code>__call__</code> method correlates each output filter with the input image and adds the bias.  Each filtered output is added to a list, and converted to a single-element batch.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">MyConv2D</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">biases</span><span class="p">,</span> <span class="n">strides</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span> <span class="o">=</span> <span class="n">filters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">biases</span> <span class="o">=</span> <span class="n">biases</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">strides</span> <span class="o">=</span> <span class="n">strides</span> 
        
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">):</span>
        <span class="n">biases</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">strides</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">biases</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">strides</span>
        
        <span class="n">num_output_channels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">biases</span><span class="p">)</span>
        
        <span class="c1"># get the first image</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>
        
        <span class="c1"># get the list of output feature maps</span>
        
        <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">filter_image_v2</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">biases</span><span class="p">,</span> <span class="n">strides</span><span class="p">)</span> <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outputs</span>

        
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">],[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">],[</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">]])</span>
<span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<span class="n">z</span><span class="o">.</span><span class="n">shape</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>(2, 3, 3)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Compare-to-Keras">
<a class="anchor" href="#Compare-to-Keras" aria-hidden="true"><span class="octicon octicon-link"></span></a>Compare to Keras<a class="anchor-link" href="#Compare-to-Keras"> </a>
</h2>
<p>To compare my convolutional layer to Keras', I need to get any convolutional-relevant parameters from the Keras model and use them to initialize my layer.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">kernels</span><span class="p">,</span> <span class="n">biases</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
<span class="n">strides</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strides</span>
<span class="n">keras_conv_features</span> <span class="o">=</span> <span class="n">keras_features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
<span class="ansi-green-fg">/tmp/ipykernel_280627/4206355748.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span>kernels<span class="ansi-blue-fg">,</span> biases <span class="ansi-blue-fg">=</span> model<span class="ansi-blue-fg">.</span>layers<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">.</span>get_weights<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      2</span> strides <span class="ansi-blue-fg">=</span> model<span class="ansi-blue-fg">.</span>layers<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">.</span>strides
<span class="ansi-green-intense-fg ansi-bold">      3</span> keras_conv_features <span class="ansi-blue-fg">=</span> keras_features<span class="ansi-blue-fg">[</span><span class="ansi-cyan-fg">0</span><span class="ansi-blue-fg">]</span>

<span class="ansi-red-fg">NameError</span>: name 'model' is not defined</pre>
</div>
</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">my_layer</span> <span class="o">=</span> <span class="n">MyConv2D</span><span class="p">(</span><span class="n">kernels</span><span class="p">,</span> <span class="n">biases</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">)</span>
<span class="n">my_conv_features</span> <span class="o">=</span> <span class="n">my_layer</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">keras_conv_features</span><span class="p">,</span> <span class="n">my_conv_features</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">))</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">jax_result</span><span class="p">,</span> <span class="n">my_conv_features</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Convolution-in-JAX">
<a class="anchor" href="#Convolution-in-JAX" aria-hidden="true"><span class="octicon octicon-link"></span></a>Convolution in JAX<a class="anchor-link" href="#Convolution-in-JAX"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">jax_result</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">conv_general_dilated</span><span class="p">(</span>
    <span class="n">lhs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
    <span class="n">rhs</span><span class="o">=</span><span class="n">kernels</span><span class="p">,</span>
    <span class="n">window_strides</span><span class="o">=</span><span class="n">strides</span><span class="p">,</span>
    <span class="n">padding</span><span class="o">=</span><span class="s1">'valid'</span><span class="p">,</span>
    <span class="n">dimension_numbers</span><span class="o">=</span><span class="p">(</span><span class="s1">'NHWC'</span><span class="p">,</span> <span class="s1">'HWIO'</span><span class="p">,</span> <span class="s1">'NHWC'</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

</div>



  </div><a class="u-url" href="/technicalities/jax/convolution/pooling/2022/07/26/jax-01-convolutional-layers.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/technicalities/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/technicalities/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/technicalities/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>A repository of code and other technical stuff.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/fastai" target="_blank" title="fastai"><svg class="svg-icon grey"><use xlink:href="/technicalities/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/fastdotai" target="_blank" title="fastdotai"><svg class="svg-icon grey"><use xlink:href="/technicalities/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
